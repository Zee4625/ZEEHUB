local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- === CONFIGURARE ===
local SETTINGS = {
	ToggleKey = Enum.KeyCode.P,
	TextSize = 22, -- Dimensiune ajustată conform cerinței
	TextColor = Color3.fromRGB(255, 255, 255),
	HighlightFill = Color3.fromRGB(255, 50, 50),
	HighlightOutline = Color3.fromRGB(255, 255, 255),
	MaxSpeed = 300, -- viteza de farm
}

local espEnabled = true 
local farmEnabled = false
local activeESPs = {}

-- === GUI (DRAGGABLE) ===
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "FruitESPGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 120, 0, 80) -- mărire pentru 2 butoane
MainFrame.Position = UDim2.new(0.1, 0, 0.1, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

-- === BUTTON ESP ===
local StatusButton = Instance.new("TextButton")
StatusButton.Name = "StatusButton"
StatusButton.Size = UDim2.new(1, 0, 0.5, 0)
StatusButton.Position = UDim2.new(0,0,0,0)
StatusButton.BackgroundTransparency = 1
StatusButton.Font = Enum.Font.GothamBold
StatusButton.TextSize = 14
StatusButton.TextColor3 = Color3.fromRGB(0, 255, 100)
StatusButton.Text = "ESP: ON"
StatusButton.Parent = MainFrame

-- === BUTTON FARM ===
local FarmButton = Instance.new("TextButton")
FarmButton.Name = "FarmButton"
FarmButton.Size = UDim2.new(1, 0, 0.5, 0)
FarmButton.Position = UDim2.new(0,0,0.5,0)
FarmButton.BackgroundTransparency = 1
FarmButton.Font = Enum.Font.GothamBold
FarmButton.TextSize = 14
FarmButton.TextColor3 = Color3.fromRGB(0, 255, 100)
FarmButton.Text = "FARM: OFF"
FarmButton.Parent = MainFrame

-- Logică de Dragging
local dragging, dragInput, dragStart, startPos
MainFrame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = MainFrame.Position
	end
end)
UserInputService.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
		local delta = input.Position - dragStart
		MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)
UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)

-- === LOGICĂ ESP ===
local function cleanName(fullName)
	return fullName:gsub(" Fruit", "")
end

local function removeESP(model)
	if activeESPs[model] then
		if activeESPs[model].Connection then activeESPs[model].Connection:Disconnect() end
		if activeESPs[model].Visuals then
			for _, v in pairs(activeESPs[model].Visuals) do if v then v:Destroy() end end
		end
		activeESPs[model] = nil
	end
end

local function clearAllESP()
	for model, _ in pairs(activeESPs) do removeESP(model) end
end

local function createESP(model)
	if not espEnabled or activeESPs[model] then return end
	local handle = model:FindFirstChild("Handle") or model:FindFirstChildWhichIsA("BasePart")
	if not handle then return end

	local highlight = Instance.new("Highlight")
	highlight.Adornee = model
	highlight.FillColor = SETTINGS.HighlightFill
	highlight.OutlineColor = SETTINGS.HighlightOutline
	highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
	highlight.Parent = model

	local billboard = Instance.new("BillboardGui")
	billboard.Adornee = handle
	billboard.Size = UDim2.new(0, 200, 0, 70)
	billboard.AlwaysOnTop = true
	billboard.ExtentsOffset = Vector3.new(0, 2.5, 0)
	billboard.Parent = model

	local textLabel = Instance.new("TextLabel")
	textLabel.Size = UDim2.new(1, 0, 1, 0)
	textLabel.BackgroundTransparency = 1
	textLabel.TextColor3 = SETTINGS.TextColor
	textLabel.TextStrokeTransparency = 0.2
	textLabel.Font = Enum.Font.GothamBold
	textLabel.TextSize = SETTINGS.TextSize
	textLabel.TextWrapped = false
	textLabel.Parent = billboard

	local connection = RunService.RenderStepped:Connect(function()
		if espEnabled and model.Parent and handle.Parent and LocalPlayer.Character then
			local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
			if root then
				local dist = (root.Position - handle.Position).Magnitude
				textLabel.Text = string.format("%s\n[%.0f m]", cleanName(model.Name), dist)
			end
		else
			removeESP(model)
		end
	end)

	activeESPs[model] = {Visuals = {highlight, billboard}, Connection = connection}
end

local function runScan()
	if not espEnabled then return end
	for _, obj in ipairs(Workspace:GetChildren()) do
		if (obj:IsA("Model") or obj:IsA("Tool")) and obj.Name:find("Fruit") then
			createESP(obj)
		end
	end
end

-- === FARM LOGIC ===
local function getCharacter()
	while not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") do
		LocalPlayer.CharacterAdded:Wait()
	end
	return LocalPlayer.Character
end

local function toggleNoclip(state)
	for _, v in pairs(getCharacter():GetChildren()) do
		if v:IsA("BasePart") then
			v.CanCollide = not state
		end
	end
end

local function TeleportToFruit(fruitHandle, speed)
	speed = speed or SETTINGS.MaxSpeed
	toggleNoclip(true)
	local hrp = getCharacter().HumanoidRootPart
	while (hrp.Position - fruitHandle.Position).Magnitude > 1 do
		local dir = (fruitHandle.Position - hrp.Position).Unit
		hrp.CFrame = hrp.CFrame + dir * (speed * task.wait())
	end
	toggleNoclip(false)
end

local function farmLoop()
	while true do
		if farmEnabled then
			local fruits = {}
			for _, obj in ipairs(Workspace:GetChildren()) do
				if obj:IsA("Model") and obj.Name:find("Fruit") and obj:FindFirstChild("Handle") then
					table.insert(fruits, obj)
				end
			end
			table.sort(fruits, function(a,b)
				return (getCharacter().HumanoidRootPart.Position - a.Handle.Position).Magnitude <
					   (getCharacter().HumanoidRootPart.Position - b.Handle.Position).Magnitude
			end)
			if #fruits > 0 then
				TeleportToFruit(fruits[1].Handle)
			end
		end
		task.wait(0.1)
	end
end

task.spawn(farmLoop)

-- === UPDATE STARE ===
local function updateESPStatus()
	if espEnabled then
		StatusButton.Text = "ESP: ON"
		StatusButton.TextColor3 = Color3.fromRGB(0, 255, 100)
		runScan()
	else
		StatusButton.Text = "ESP: OFF"
		StatusButton.TextColor3 = Color3.fromRGB(255, 50, 50)
		clearAllESP()
	end
end

local function updateFarmStatus()
	if farmEnabled then
		FarmButton.Text = "FARM: ON"
		FarmButton.TextColor3 = Color3.fromRGB(0, 255, 100)
	else
		FarmButton.Text = "FARM: OFF"
		FarmButton.TextColor3 = Color3.fromRGB(255, 50, 50)
	end
end

StatusButton.MouseButton1Click:Connect(function()
	espEnabled = not espEnabled
	updateESPStatus()
end)

FarmButton.MouseButton1Click:Connect(function()
	farmEnabled = not farmEnabled
	updateFarmStatus()
end)

UserInputService.InputBegan:Connect(function(input, processed)
	if not processed then
		if input.KeyCode == SETTINGS.ToggleKey then
			espEnabled = not espEnabled
			updateESPStatus()
		end
	end
end)

Workspace.ChildAdded:Connect(function(child)
	if espEnabled and child.Name:find("Fruit") then
		task.wait(0.5)
		createESP(child)
	end
end)

updateESPStatus()
updateFarmStatus()
